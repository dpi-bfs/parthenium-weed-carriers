# Parthenium Weed Carrier - Typescript API

## Confluence Documentation

todo

## Code orientation (todo)

### The routes ...

Route: /form-webhook ... src/formWebhook.ts listens for a submission post request from the OneBlink form Submission event. It then, synchronously and in order:

* Generates the Certificate PDF from a pdf template (src/templates/pdf.mustache)
* Emails the PDF to the user, using an email template for the body (src/templates/emailPlain.mustache)
* Posts Certificate/Submission data, including the PDF certificate, to a Power Automate flow. The Power Automate flow then inserts the data and pdf into a sharepoint list.

Route: /externalId. ... src/externalID.ts listens for a Receipt ID post request from the OneBlink form. And returns an 8 char trackingCode. The 8 chars code:

* Is 8 characters to advertise that it is not the usual OneBlink 6 character generated by the BFS custom wrappers.
* Excludes look alike characters (e.g. "0" and "O"; etc). 

#### The templates

src/templates/pdf.mustache is written in HTML and CSS and conveniently stuffs variables passed to it. The parameters are contained in the bracket "mustache"s e.g. {{ MyVariable }}.

Also src/templates/emailPlain.mustache

#### The Certificate PDF

The user only ever needs to use the Certificate reference code when communicating with Food Authority Staff (and even then their name and date could be used in lieu):

  The SubmissionID is on the certificate, invisible but selectable, beneath the last body line, e.g. ...

  > Issued by the NSW Food Authority | Certificate reference code: T9XBKWBK

  ... and above the footer.

  The motivation for including it was that part way through development we couldn't get the Certificate reference code: (aka ExternalID, trackingCode, Title) into the OneBlink submission records and so SubmissionID was the only reference back to OneBlink itself. A belt and braces move given our Sharepoint list had (and has) both SubmissionID and Certificate reference code (as "Title"). However the final code successfully includes the Certificate reference code: (aka ExternalID, trackingCode, Title) in the OneBlink submission records. S

### Deploy

We deploy using the OneBlink API CLI, @oneblink/cli. See https://github.com/oneblink/cli/blob/master/docs/api/README.md


* OneBlink Authenticate to enable deployment, either:

  + Use Deployment Keys https://github.com/oneblink/cli/blob/master/docs/api/deployment-keys.md

    Set Deployment keys in your local OS Environment command line session e.g.

    Get these from OneBlink Console > Developer Tools > Developer Keys > Food Handler Basics Certificate (Note APIs is enabled)

        PS> $ENV:ONEBLINK_ACCESS_KEY="TheKey"
        PS> $ENV:ONEBLINK_SECRET_KEY="TheSecret"

  Or

  + Login with OneBlink Console credentials and paste back a key supplied by a browser page which will automatically pop up.
  
        PS> npx oneblink login 

* Deploy

      PS> npx oneblink api deploy --env dev;Get-Date

### The remaining backend

* Power Automate Flows. See https://nswfood.atlassian.net/wiki/spaces/BD/pages/2600829062/Food+Handler+Basics+Certificate+-+Spec#Tech-Stack

* Sharepoint Lists. See https://nswfood.atlassian.net/wiki/spaces/BD/pages/2600829062/Food+Handler+Basics+Certificate+-+Spec#Tech-Stack

### Code basis

This code with derived from:

* OneBlink's Custom Email API Hosting Template: https://github.com/oneblink/custom-email-api.
* OneBlink supplied MailGun functionality, as in src\library\mailgunWrapper.mts with slight modifications.

The code:

* Uses the OneBlink SDK: https://github.com/oneblink/sdk-node-js
* Is deployed with the OneBlink CLI: https://github.com/oneblink/cli/blob/master/docs/README.md

## Get a copy of this code, update it, deploy it, test it

(You could also follow the same steps for using this code as the basis for a similar project).

### Local files setup

* Clone https://github.com/dpi-bfs/todo locally. At https://github.com/dpi-bfs/, the Dept. of Primary Industries Biosecurity and Food Safety Github, we used a Centralized/Shared repo Workflow (rather than the Fork and Pull Workflow). That is, there's one central remote repo to pull from and push to.

* Get the .blinkmrc.json file, for this Food Hander Basics Certificate code base, from a colleague. It contains secrets. Or recreate it:
  - Copy .blinkmrc-example.json to .blinkmrc.json
  - project: comes from OneBlink Console > Developer Tools > API Hosting > nswfoodauthority-foodhandler.api.oneblink.io (was previously created).
  - vpcSubnets and vpcSecurityGroups: supplied by OneBlink
  - routes: something we can arbitrarily define. This is then referenced in our form in an environment specific way. E.g. OneBlink Console  > DEV > Forms > Parthenium Weed Carrier - Record of Movement > |Workflow| > Submission Events > Webhook:Hosted API > 
    + Hosted API: https://nswfoodauthority-parthenium-carrier-dev.api.oneblink.io (note "dev" is inserted into our project string "nswfoodauthority-parthenium-carrier.api.oneblink.io")
    + Route: /rom-approval-event. See e.g. OneBlink Console  > DEV > Forms > Parthenium Weed Carrier - Record of Movement > |Workflow| > Approval Events > Webhook:Hosted API 

  - Variables:
    + "SENDER_EMAIL_ADDRESS": "weed@dpi.nsw.gov.au"
    + "WEB_HOOK_SECRET": A GUID generated via Powershell (could come from anywhere) and pasted into OneBlink Console  > [ENV] > Forms > Parthenium Weed Carrier - Record of Movement > |Workflow| > Approval Events > Webhook:Hosted API > Secret
    + "FORMS_ACCESS_KEY" & "FORMS_SECRET_KEY". From  OneBlink Console > Developer Tools > Developer Keys > Food Handler Basics Certificate. Key ID & Key Secret. Note "Forms" is enabled.
    + "PDF_ACCESS_KEY" & "PDF_SECRET_KEY". From  OneBlink Console > Developer Tools > Developer Keys > Food Handler Basics Certificate. Key ID & Key Secret. Note "Forms" is enabled.
    + "MAILGUN_DOMAIN": "bfs.dpi.nsw.gov.au",
    + "MAILGUN_USERNAME": "api"
    + "MAILGUN_API_SECRET_KEY": Get from MailGun console.
    + "POWER_AUTOMATE_SECRET_KEY": A GUID generated via Powershell (could come from anywhere). The Power Automate Flows (that take the submission data and pdf cert and insert into a Sharepoint list), which /rom-approval-event triggers, manually look for this secret and halts if not found.
    + "POWER_AUTOMATE_HTTP_POST_URL": Environment specific urls that are generated by MS in the Power Automate flow in a "When a HTTP request is received" component. 
    + "ONEBLINK_ENVIRONMENT": used for logging the environment. Might be superfluous given OneBlink logs are found within particular environments.
    + "ENV_PREFIX": Used to prefix email subject lines (and the like) to help identify where emails are coming from during development and testing.

* blinkmrc.json is kept out of the git repo (through .gitignore) as it references secrets.

* Install Node.js https://nodejs.org/en/download. This includes Node Package Manager (npm)



### Work on code

* Check for updates

      npx npm-check-updates --upgrade

* Install/Update new packages.

      npm install
      npm update   

* To build the Typescript files, including assets, to /out use the following in a terminal instance.

      npm run watch

  After execution this will automatically update changed files in /src to /output.

  `npm-run-all` is needed to execute multiple commands properly on Windows (and is a cross platform solution https://github.com/mysticatea/npm-run-all)

  Observe package.json for the `npm run watch` script dependencies, e.g. ...

      "config": {
        "externalLibraryPath": "../../../Typescript/library/",
        "externalLibraryFileList": "dateTime.* mailgunWrapper.* maths.* oneblinkSdkHelpers.* sendPostRequest.* stringTools.* "
      },
      "scripts": {
        "print": "echo %npm_package_config_externalLibraryPath%",
        "watch-typescript": "npx tsc --watch",
        "mirror-library-files": "robocopy %npm_package_config_externalLibraryPath% src/lib %npm_package_config_externalLibraryFileList% /MIR /lev:1",
        "watch-library-files": "chokidar %npm_package_config_externalLibraryPath%*.{ts,mts} -c \"npm run mirror-library-files\" --initial",
        "copy-assets": "copyfiles -u 1 src/templates/*.mustache out",
        "watch-assets": "chokidar \"src/templates/**/*\" -c \"npm run copy-assets\" --initial",
        "clean": "rimraf out",
        "watch": "npm-run-all clean --parallel watch-assets watch-library-files watch-typescript",
        "local-serve": "npx oneblink api serve --env dev",
        "debug": "npm-run-all --serial watch-typescript local-serve"
      },

* (For convenience) Rename the terminal instance "watch"

* Open the following in two more terminal instances

    C:\Users\John\...\Documents\Sda\Code\Typescript\library> npm run watch
    C:\Users\John\...\Documents\Sda\Code\Typescript\library> npm test  # Optional

* Work on any code and commit it to the local git. 

* From the non-watch `\PartheniumWeedCarrier>` terminal ...

* Set Deployment Keys (alternatively use `npx oneblink login`)

    See OneBlink Console > Developer Tools > Developer Keys > Food Handler Basics Certificate. Key ID & Key Secret. or .blinkmrc.json. Set in Windows Terminal with powershell ...

    $ENV:ONEBLINK_ACCESS_KEY="TheKeyId"
    $ENV:ONEBLINK_SECRET_KEY="TheKeySecret"

* Deploy command. Each, even the local deployment, must come after authentication

    \PartheniumWeedCarrier> npx oneblink api serve --env dev;Get-Date  # local dev; or
    \PartheniumWeedCarrier> npx oneblink api deploy --env dev;Get-Date  # deployment; or

### Test code

* Prefill a form with some test data.

  - Disable browser cache.

  - Follow link

    + Full Manual Fields

      https://nswfoodauthority-dpi-forms-dev.cdn.oneblink.io/forms/19049?preFillData={"IsInspectorFillingRom":"Yes","InspectorFillingRom":"Bruce McDonald","PersonResponsibleFirstName":"Joe","PersonResponsibleLastName":"Blow","PersonResponsibleEmail":"john.bentley@dpi.nsw.gov.au","PersonResponsibleCanAccessEmailOnTheRoad":"Yes","PersonResponsibleMobilePhone":"0444 111 222","PersonResponsibleAlternatePhone":"4444 5555","InspectionFacilityIntended":"Hebel","Owner":"Another person","OwnerFirstName":"Lisa","OwnerLastName":"Simpson","OwnerEmail":"lisa.simpson@example.com","OwnerPhone":"5555 6666","Carriers":[{"CarrierType":"Grain Harvester - including comb or front","CarrierMake":"Toyota","CarrierModel":"Big Thresher","CarrierRegistrationNumber":"AAA222","CarrierSerialNumber":"111222"},{"CarrierType":"Comb trailer - including comb or front","CarrierMake":"Bigger","CarrierModel":"Frontser", "CarrierRegistrationNumber":"BBB333","CarrierSerialNumber":"333444"}],"OriginCannotFindAddressBySearch":true,"OriginManualStreetAddress":"12 Cool St","OriginManualSuburb":"COOLBURB","OriginManualState":"QLD","OriginManualPostcode":4444,"AreDestinationsKnown":"Yes - I know at least one of the destinations","Destinations":[{"DestinationCannotFindAddressBySearch":true,"DestinationManualStreetAddress":"12 Hot St","DestinationManualSuburb":"HOTBURB","DestinationManualState":"NSW","DestinationManualPostcode":2222},{"DestinationCannotFindAddressBySearch":true,"DestinationManualStreetAddress":"12 Tepid St","DestinationManualSuburb":"TEPIDBURB","DestinationManualState":"NSW","DestinationManualPostcode":2333}],"RomUserNotes":"Test data. ","IDeclareThat":["the carriers identified in this Record of Movement have been cleaned in accordance with the conditions specified in Schedule 1 of the Biosecurity Order (Permitted Activities) 2019.","the information provided in this Record of Movement is true and accurate.","I will record all the NSW destinations that all the carriers will work at this season, and pass this information to the owner.","I understand that furnishing any information to a biosecurity certifier that is false or misleading, or failing to furnish information is an offence under the NSW Biosecurity Act 2015."]}

      https://forms-test.bfs.dpi.nsw.gov.au/forms/19227
      https://forms-train.bfs.dpi.nsw.gov.au/forms/20252
      https://forms.bfs.dpi.nsw.gov.au/forms/19564


    + Full Lookup Fields

      (Todo)
      https://nswfoodauthority-dpi-forms-dev.cdn.oneblink.io/forms/19049?
      https://forms-test.bfs.dpi.nsw.gov.au/forms/19227?preFillData={"IsInspectorFillingRom":"Yes","InspectorFillingRom":"Bruce McDonald","PersonResponsibleFirstName":"Joe","PersonResponsibleLastName":"Blow","PersonResponsibleEmail":"john.bentley@dpi.nsw.gov.au","PersonResponsibleCanAccessEmailOnTheRoad":"Yes","PersonResponsibleMobilePhone":"0444 111 222","PersonResponsibleAlternatePhone":"4444 5555","InspectionFacilityIntended":"Boggabilla","Owner":"Another person","OwnerFirstName":"Lisa","OwnerLastName":"Simpson","OwnerEmail":"john.bentley@dpi.nsw.gov.au","OwnerPhone":"1111 2222","Carriers":[{"CarrierType":"Grain Harvester - including comb or front","CarrierMake":"Toyota","CarrierModel":"Big Thresher","CarrierRegistrationNumber":"AAA222","CarrierSerialNumber":"111222"},{"CarrierType":"Comb trailer - including comb or front","CarrierMake":"Bigger","CarrierModel":"Frontser", "CarrierRegistrationNumber":"BBB333","CarrierSerialNumber":"333444"}],"OriginCannotFindAddressBySearch":false, "OriginAddressNswPoint": { "addressDetails": { "aliasPrincipal": "PRINCIPAL", "cadastralIdentifier": "1197/SP300872", "dataset": "gnaf,continuousAddress", "deliveryPointIdentifier": "46098816", "formattedAddress": "15 LEAF ST, GREENBANK QLD 4124", "jurisdictionId": "2966965-PC", "localityAlias": [ "BORONIA HEIGHTS", "FORESTDALE", "JIMBOOMBA", "MUNRUBEN", "NEW BEITH", "NORTH MACLEAN", "PARK RIDGE SOUTH" ], "localityId": "loc294343900699", "localityName": "GREENBANK", "localityNeighbour": [ "BORONIA HEIGHTS", "CAMIRA", "CAROLE PARK", "FOREST LAKE", "FORESTDALE", "HEATHWOOD", "HILLCREST", "LYONS", "MUNRUBEN", "NEW BEITH", "NORTH MACLEAN", "PARK RIDGE", "PARK RIDGE SOUTH", "SOUTH RIPLEY", "SPRING MOUNTAIN", "SPRINGFIELD", "SPRINGFIELD LAKES" ], "lotIdentifier": "1197", "postcode": "4124", "stateTerritory": "QLD", "streetLocalityId": "QLDL3622833", "streetName": "LEAF", "streetNumber1": "15", "streetType": "ST", "streetTypeDescription": "STREET" }, "addressId": "GAQLD720596909", "addressRecordType": "PRIMARY", "asgsMain": { "2016": { "mbId": "30012260000", "sa1Id": "31104132013", "sa2Id": "311041320", "sa3Id": "31104", "sa4Id": "311" }, "2021": { "mbId": "36314300000", "sa1Id": "31104156906", "sa2Id": "311041569", "sa3Id": "31104", "sa4Id": "311" } }, "commonwealthElectorate": { "commElectoralName": "WRIGHT", "commElectoralPid": "QLD30" }, "dataset": "GNAF", "geo": { "crs": "<https://www.opengis.net/def/crs/EPSG/0/4283>", "geoDatumCode": "GDA94", "geoFeature": "PROPERTY CENTROID", "geometry": { "coordinates": [ 152.98784391, -27.74230633 ], "type": "Point" } }, "localGovernmentArea": { "lgaName": "Logan City", "lgaPid": "lgad15a5a116e04", "lgaShortName": "Logan" }, "messages": [ { "code": "NONE", "description": "You have requested something that is not available.", "message": "cadastralParcels information is not available for GAQLD720596909", "severity": "INFO" } ], "properties": { "pafExpiryDate": "01-01-2024", "pafVersion": 23.4 }, "stateElectorate": [ { "stateElectoralClassCode": "2", "stateElectoralName": "LOGAN", "stateElectoralPid": "QLD237", "stateElectoralType": "Legislative Assembly" } ] } ,"AreDestinationsKnown":"Yes - I know at least one of the destinations","RomUserNotes":"Test data. ","IDeclareThat":["the carriers identified in this Record of Movement have been cleaned in accordance with the conditions specified in Schedule 1 of the Biosecurity Order (Permitted Activities) 2019.","the information provided in this Record of Movement is true and accurate.","I will record all the NSW destinations that all the carriers will work at this season, and pass this information to the owner.","I understand that furnishing any information to a biosecurity certifier that is false or misleading, or failing to furnish information is an offence under the NSW Biosecurity Act 2015."]}    

  - Press Start

## Test Locally

John's Documents\Sda\Info\OneBlink\OneBlinkApiNotes.md, Test locally


value:Object









,,,,